<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Color-Coded Bible</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Hebrew&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans Hebrew', 'Arial', sans-serif;
            background-color: #f9f9f9;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }

        h1 {
            text-align: center;
            color: #333;
        }

        .filter-buttons, .book-filter {
            text-align: center;
            margin-bottom: 20px;
        }

        .filter-buttons button, .book-filter button {
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            font-size: 16px;
            border-radius: 5px;
            transition: background-color 0.3s ease;
            color: white;
        }

        /* Device Color Classes */
        .device-waw-explicativum {
            background-color: yellow;
            color: black;
        }
        
        .device-hendiadys {
            background-color: lightblue;
            color: black;
        }

        .device-waw-explicativum .highlight,
        .device-hendiadys .highlight {
            font-weight: bold;
        }

        .verses {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .verse {
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }

        footer {
            text-align: center;
            margin-top: 20px;
            color: #777;
        }

        /* Style for superscript numbers */
.superscript {
    font-size: 0.7em;
    vertical-align: super;
}

/* Style for source mapping */
.source-block {
    margin-top: 10px;
    font-size: 14px;
}

.source-block a {
    color: #6A0DAD;  /* Change this to match the theme */
    text-decoration: none;
}
    </style>
</head>
<body>

    <h1>Color-Coded Bible</h1>

     <!-- Book filter buttons -->
     <div class="book-filter">
        <button onclick="filterByBook('Genesis')">Genesis</button>
        <button onclick="filterByBook('Exodus')">Exodus</button>
        <button onclick="filterByBook('Leviticus')">Leviticus</button>
        <button onclick="filterByBook('Numbers')">Numbers</button>
        <button onclick="filterByBook('Deuteronomy')">Deuteronomy</button>
        <!-- Prophets -->
        <button onclick="filterByBook('Joshua')">Joshua</button>
        <button onclick="filterByBook('Judges')">Judges</button>
        <button onclick="filterByBook('I Samuel')">I Samuel</button>
        <button onclick="filterByBook('II Samuel')">II Samuel</button>
        <button onclick="filterByBook('I Kings')">I Kings</button>
        <button onclick="filterByBook('II Kings')">II Kings</button>
        <button onclick="filterByBook('Isaiah')">Isaiah</button>
        <button onclick="filterByBook('Jeremiah')">Jeremiah</button>
        <button onclick="filterByBook('Ezekiel')">Ezekiel</button>
        <button onclick="filterByBook('Hosea')">Hosea</button>
        <button onclick="filterByBook('Joel')">Joel</button>
        <button onclick="filterByBook('Amos')">Amos</button>
        <button onclick="filterByBook('Obadiah')">Obadiah</button>
        <button onclick="filterByBook('Jonah')">Jonah</button>
        <button onclick="filterByBook('Micah')">Micah</button>
        <button onclick="filterByBook('Nahum')">Nahum</button>
        <button onclick="filterByBook('Habakkuk')">Habakkuk</button>
        <button onclick="filterByBook('Zephaniah')">Zephaniah</button>
        <button onclick="filterByBook('Haggai')">Haggai</button>
        <button onclick="filterByBook('Zechariah')">Zechariah</button>
        <button onclick="filterByBook('Malachi')">Malachi</button>
        <!-- Writings -->
        <button onclick="filterByBook('Psalms')">Psalms</button>
        <button onclick="filterByBook('Proverbs')">Proverbs</button>
        <button onclick="filterByBook('Job')">Job</button>
        <button onclick="filterByBook('Song of Songs')">Song of Songs</button>
        <button onclick="filterByBook('Ruth')">Ruth</button>
        <button onclick="filterByBook('Lamentations')">Lamentations</button>
        <button onclick="filterByBook('Ecclesiastes')">Ecclesiastes</button>
        <button onclick="filterByBook('Esther')">Esther</button>
        <button onclick="filterByBook('Daniel')">Daniel</button>
        <button onclick="filterByBook('Ezra')">Ezra</button>
        <button onclick="filterByBook('Nehemiah')">Nehemiah</button>
        <button onclick="filterByBook('I Chronicles')">I Chronicles</button>
        <button onclick="filterByBook('II Chronicles')">II Chronicles</button>
    </div>

    <div class="filter-buttons">
        <button class="device-waw-explicativum" onclick="filterByDevice('waw-explicativum')">Waw Explicativum</button>
        <button class="device-hendiadys" onclick="filterByDevice('hendiadys')">Hendiadys</button>
        <!-- More device buttons -->
    </div>

    <div class="verses">
        <p>Please select a book or device to view verses.</p>
    </div>

    <footer>
        Powered by JavaScript & Google Sheets API | Designed for easier exploration of literary devices in the Bible
    </footer>

    <script>
        const API_KEY = 'AIzaSyAJH1Uoae-nnNRq2DmMUsdOUwhhsW2E8yU';
        const SHEET_ID = '1AQigxLa6S8HAoVeUYohh4AjQ_9YU_HgXBjuXZdl6msg';
        const RANGE = 'tanakh_verses_hebrew!A:H';

        let versesData = [];

        const deviceColors = {
            'waw-explicativum': 'device-waw-explicativum',
            'hendiadys': 'device-hendiadys'
            // Add more devices and their corresponding classes
        };

        // Load the Google Sheets data
        function loadVerses(callback) {
            if (versesData.length === 0) {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${API_KEY}`;
                
                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        versesData = data.values || [];
                        callback();
                    })
                    .catch(error => console.error('Error loading Google Sheets data:', error));
            } else {
                callback();
            }
        }

        // Display the verses with device highlights and filters
        // Display the verses with device highlights and correct numbering
// Display the verses with device highlights and correct numbering
// Display the verses with device highlights and correct numbering
function displayVerses(filterFn) {
    const versesContainer = document.querySelector('.verses');
    versesContainer.innerHTML = ''; // Clear previous verses

    let hasVerses = false;
    const verseMap = {};

    // Process all rows to accumulate devices for the same verse
    versesData.forEach(row => {
        const [book, chapter, verse, text, device, words, sources, urls] = row;
        if (!book || !chapter || !verse || !text) return;

        const verseKey = `${book} ${chapter}:${verse}`;
        if (!verseMap[verseKey]) {
            verseMap[verseKey] = {
                text: text,
                devices: [],
                sources: [],
                urls: []
            };
        }

        // Add the device and words
        verseMap[verseKey].devices.push({ device, words });

        // Split sources and URLs by semicolons
        const sourceArray = sources ? sources.split(';').map(src => src.trim()) : [];
        const urlArray = urls ? urls.split(';').map(url => url.trim()) : [];

        // Add sources and URLs
        verseMap[verseKey].sources.push(sourceArray); // Store as array of arrays
        verseMap[verseKey].urls.push(urlArray);       // Store as array of arrays
    });

    // Display the verses based on the filter
    Object.keys(verseMap).forEach(verseKey => {
        const verseData = verseMap[verseKey];
        const [book, chapterVerse] = verseKey.split(' ', 2);

        if (filterFn(book, verseData.devices)) {
            hasVerses = true;

            // Create the verse container
            const verseDiv = document.createElement("div");
            verseDiv.className = "verse";

            // Reverse the superscript numbering for RTL Hebrew text
            let highlightedText = verseData.text;
            let sourceCounter = verseData.devices.length; // Start from the highest number for RTL text
            let sourceMapping = [];  // Store each source mapping

            verseData.devices.forEach((d, index) => {
                if (d.words) {
                    const regex = new RegExp(d.words, 'g');
                    // Add superscript for each device without the device name
                    highlightedText = highlightedText.replace(regex, `<span class="highlight ${deviceColors[d.device.toLowerCase()]}">${d.words}<sup class="superscript">${sourceCounter}</sup></span>`);

                    // Add the sources for this device, along with the device name
                    let sourcesForDevice = verseData.sources[index].map((source, srcIndex) => 
                        `<a href="${verseData.urls[index][srcIndex]}" class="source" target="_blank">${source}</a>`
                    ).join(', ');

                    // Add to source mapping, showing both device name and sources
                    sourceMapping.push(`<span class="${deviceColors[d.device.toLowerCase()]}">${sourceCounter}. (${d.device}) ${sourcesForDevice}</span>`);
                    sourceCounter--; // Decrement for next device
                }
            });

            // Reverse the source order to match the correct RTL superscript order
            sourceMapping.reverse();

            // Construct the source mapping below the verse
            let sourcesDisplay = `<div class="source-block">${sourceMapping.join('<br>')}</div>`;

            // Add the verse text and sources to the verse container
            verseDiv.innerHTML = `<span>${verseKey}</span> <span>${highlightedText}</span><br/>${sourcesDisplay}`;
            versesContainer.appendChild(verseDiv);
        }
    });

    if (!hasVerses) {
        versesContainer.innerHTML = '<p>No verses found for the selected filter.</p>';
    }
}

        // Filter by Literary Device
        function filterByDevice(device) {
            loadVerses(() => {
                displayVerses((book, devices) => {
                    return devices.some(d => {
                        if (d.device) {
                            return !device || d.device.toLowerCase() === device.toLowerCase();
                        }
                        return false;
                    });
                });
            });
        }

        // Filter by Book
        function filterByBook(book) {
            loadVerses(() => {
                displayVerses((currentBook) => currentBook === book);
            });
        }

        // Initial display showing all devices by default
        loadVerses(() => {
            displayVerses(() => true); // Show all devices on page load
        });
    </script>
</body>
</html>